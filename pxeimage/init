#!/bin/busybox sh

# Early setup
export PATH=/bin:/sbin:/usr/bin:/usr/sbin

/bin/busybox mount -t proc proc /proc
/bin/busybox mount -t sysfs sys /sys
/bin/busybox mount -t devtmpfs dev /dev 2>/dev/null || /bin/busybox mdev -s
/bin/busybox mkdir -p /dev/pts /run /var/run /tmp
/bin/busybox mount -t devpts devpts /dev/pts 2>/dev/null

# Redirect all output to serial console
exec >/dev/ttyS1 2>&1

/bin/busybox echo "=== Bare Metal Services Booting ==="

# Load SATA/AHCI drivers
/bin/busybox modprobe ahci 2>/dev/null
/bin/busybox modprobe libata 2>/dev/null
/bin/busybox modprobe sd_mod 2>/dev/null
/bin/busybox modprobe sr_mod 2>/dev/null
/bin/busybox modprobe ata_piix 2>/dev/null
/bin/busybox sleep 2

# Load network drivers
/bin/busybox modprobe e1000 2>/dev/null
/bin/busybox modprobe e1000e 2>/dev/null
/bin/busybox modprobe igb 2>/dev/null
/bin/busybox modprobe ixgbe 2>/dev/null
/bin/busybox modprobe r8169 2>/dev/null
/bin/busybox modprobe virtio_net 2>/dev/null
/bin/busybox modprobe mlx4_core 2>/dev/null
/bin/busybox modprobe mlx4_en 2>/dev/null
/bin/busybox modprobe mlx5_core 2>/dev/null

# Build module dependencies and load IPMI drivers
/sbin/depmod -a 2>/dev/null
/bin/busybox modprobe ipmi_msghandler 2>/dev/null
/bin/busybox modprobe ipmi_devintf 2>/dev/null
/bin/busybox modprobe ipmi_si 2>/dev/null

/bin/busybox hostname baremetalservices
/bin/busybox ip link set lo up

# Set hostname from reverse DNS after network is up (runs in background)
(sleep 10; ETH0_IP=$(/bin/busybox ip -4 addr show eth0 2>/dev/null | /bin/busybox grep "inet " | /bin/busybox awk '{print $2}' | /bin/busybox cut -d/ -f1); \
 if [ -n "$ETH0_IP" ]; then \
   RDNS=$(/bin/busybox nslookup "$ETH0_IP" 2>/dev/null | /bin/busybox grep "name = " | /bin/busybox awk '{print $NF}' | /bin/busybox sed 's/\.$//'); \
   if [ -n "$RDNS" ]; then \
     /bin/busybox hostname "$RDNS"; \
     /bin/busybox echo "Hostname set to: $RDNS"; \
   fi; \
 fi) &

# Enable passwordless root login with valid shell
/bin/busybox sed -i 's|^root:.*|root:x:0:0:root:/root:/bin/ash|' /etc/passwd
/bin/busybox sed -i 's|^root:.*|root::0::::::|' /etc/shadow 2>/dev/null || true

# Fix SSH authorized_keys ownership
/bin/busybox chown -R 0:0 /root/.ssh 2>/dev/null || true

/bin/busybox sleep 2

# Function to configure interface with DHCP retries (runs in background for non-primary)
configure_interface_bg() {
    local iface=$1
    local max_retries=60

    /bin/busybox echo "[$iface] Starting background configuration..."
    /bin/busybox ip link set $iface up
    /bin/busybox sleep 1

    # Set 10G mode for high-speed NICs
    DRIVER=$(/bin/busybox readlink /sys/class/net/$iface/device/driver 2>/dev/null | /bin/busybox xargs basename 2>/dev/null)
    if [ "$DRIVER" = "mlx4_core" ] || [ "$DRIVER" = "ixgbe" ]; then
        /bin/busybox echo "[$iface] Setting 10G, autoneg off"
        /usr/sbin/ethtool -s $iface autoneg off speed 10000 duplex full 2>/dev/null || true
    fi

    # Send broadcast ping to wake up switch port
    /bin/busybox ping -c 3 -b 255.255.255.255 -I $iface 2>/dev/null || true
    /bin/busybox sleep 1

    # Retry DHCP until success
    local retry=0
    while [ $retry -lt $max_retries ]; do
        retry=$((retry + 1))

        # Check if already has IP
        IP=$(/bin/busybox ip -4 addr show $iface 2>/dev/null | /bin/busybox grep "inet " | /bin/busybox awk '{print $2}' | /bin/busybox cut -d/ -f1)
        if [ -n "$IP" ]; then
            GATEWAY=$(/bin/busybox ip route | /bin/busybox grep default | /bin/busybox awk '{print $3}' | /bin/busybox head -1)
            if [ -n "$GATEWAY" ] && /bin/busybox ping -c 1 -W 2 -I $iface $GATEWAY >/dev/null 2>&1; then
                /bin/busybox echo "[$iface] OK: $IP (gateway reachable)"
                return 0
            fi
        fi

        # Try DHCP
        [ -f /var/run/udhcpc.$iface.pid ] && /bin/busybox kill $(/bin/busybox cat /var/run/udhcpc.$iface.pid) 2>/dev/null
        /bin/busybox udhcpc -i $iface -n -q -t 5 -T 3 2>/dev/null

        # Check result
        IP=$(/bin/busybox ip -4 addr show $iface 2>/dev/null | /bin/busybox grep "inet " | /bin/busybox awk '{print $2}' | /bin/busybox cut -d/ -f1)
        if [ -n "$IP" ]; then
            GATEWAY=$(/bin/busybox ip route | /bin/busybox grep default | /bin/busybox awk '{print $3}' | /bin/busybox head -1)
            if [ -n "$GATEWAY" ] && /bin/busybox ping -c 1 -W 2 -I $iface $GATEWAY >/dev/null 2>&1; then
                /bin/busybox echo "[$iface] OK: $IP (gateway reachable)"
                return 0
            else
                /bin/busybox echo "[$iface] Got $IP but gateway unreachable, retrying..."
                /bin/busybox ip addr flush dev $iface 2>/dev/null
            fi
        fi

        /bin/busybox sleep 5
    done

    /bin/busybox echo "[$iface] DHCP failed, starting background daemon"
    /bin/busybox udhcpc -i $iface -b -R -p /var/run/udhcpc.$iface.pid 2>/dev/null &
}

# Configure eth0 first (primary interface, blocking) - usually already has IP from PXE
/bin/busybox echo "Configuring eth0 (primary)..."
/bin/busybox ip link set eth0 up 2>/dev/null
DRIVER=$(/bin/busybox readlink /sys/class/net/eth0/device/driver 2>/dev/null | /bin/busybox xargs basename 2>/dev/null)
if [ "$DRIVER" = "mlx4_core" ] || [ "$DRIVER" = "ixgbe" ]; then
    /usr/sbin/ethtool -s eth0 autoneg off speed 10000 duplex full 2>/dev/null || true
fi

# Check if eth0 already has IP from PXE boot
ETH0_IP=$(/bin/busybox ip -4 addr show eth0 2>/dev/null | /bin/busybox grep "inet " | /bin/busybox awk '{print $2}' | /bin/busybox cut -d/ -f1)
if [ -z "$ETH0_IP" ]; then
    /bin/busybox echo "eth0: No IP, trying DHCP..."
    /bin/busybox udhcpc -i eth0 -n -q -t 10 -T 3 2>/dev/null
    ETH0_IP=$(/bin/busybox ip -4 addr show eth0 2>/dev/null | /bin/busybox grep "inet " | /bin/busybox awk '{print $2}' | /bin/busybox cut -d/ -f1)
fi

if [ -n "$ETH0_IP" ]; then
    /bin/busybox echo "eth0: $ETH0_IP"
else
    /bin/busybox echo "eth0: WARNING - no IP obtained"
fi

# Configure other interfaces in BACKGROUND (non-blocking)
for iface in $(/bin/busybox ls /sys/class/net/ | /bin/busybox grep -v -E "^(lo|eth0)$"); do
    configure_interface_bg $iface &
done

# Quick gateway check
GATEWAY=$(/bin/busybox ip route | /bin/busybox grep default | /bin/busybox awk '{print $3}' | /bin/busybox head -1)
if [ -n "$GATEWAY" ]; then
    /bin/busybox echo "Gateway: $GATEWAY"
fi

# Sync time from NTP and set hardware clock
/bin/busybox echo "Syncing time from NTP..."
if /bin/busybox ntpd -n -q -p pool.ntp.org 2>/dev/null; then
    /bin/busybox echo "Time synced: $(/bin/busybox date)"
    if /bin/busybox hwclock -w 2>/dev/null; then
        /bin/busybox echo "Hardware clock set: $(/bin/busybox hwclock -r 2>/dev/null)"
    fi
else
    /bin/busybox echo "NTP sync failed (will retry in background)"
fi
# Start ntpd in background to keep time synced
/bin/busybox ntpd -p pool.ntp.org 2>/dev/null &

/bin/busybox echo ""
/bin/busybox echo "Network:"
/bin/busybox ip -4 addr show | /bin/busybox grep "inet " | /bin/busybox grep -v "127.0.0.1"

# Start SSH server
/bin/busybox mkdir -p /etc/dropbear
/usr/sbin/dropbearkey -t rsa -f /etc/dropbear/dropbear_rsa_host_key 2>/dev/null
/usr/sbin/dropbear -B -R -E -p 22 &

# Start Bare Metal Services API
/bin/busybox echo "Starting Bare Metal Services API on port 8080..."
/usr/bin/baremetalservices &

# Display system info
/bin/busybox echo ""
/bin/busybox echo "============================================"
/bin/busybox echo "         SYSTEM INFORMATION"
/bin/busybox echo "============================================"
/bin/busybox echo "Hostname: $(/bin/busybox hostname)"
/bin/busybox echo "Kernel:   $(/bin/busybox uname -r)"
/bin/busybox echo "Time:     $(/bin/busybox date)"
/bin/busybox echo ""
/bin/busybox echo "CPU: $(/bin/busybox grep 'model name' /proc/cpuinfo | /bin/busybox head -1 | /bin/busybox cut -d: -f2 | /bin/busybox sed 's/^ //')"
/bin/busybox echo "Cores: $(/bin/busybox nproc)"
/bin/busybox echo ""
/bin/busybox echo "Memory:"
/bin/busybox free -h | /bin/busybox grep -E "Mem|total"
/bin/busybox echo ""
/bin/busybox echo "Disks:"
/bin/busybox lsblk -d -o NAME,SIZE,MODEL 2>/dev/null || /bin/busybox fdisk -l 2>/dev/null | /bin/busybox grep "Disk /dev"
/bin/busybox echo ""
/bin/busybox echo "Network:"
/bin/busybox ip -4 addr show | /bin/busybox grep "inet " | /bin/busybox grep -v "127.0.0.1"
/bin/busybox echo ""
/bin/busybox echo "============================================"
/bin/busybox echo "    Bare Metal Services Ready"
/bin/busybox echo "    SSH: root (no password) port 22"
/bin/busybox echo "    API: http://<ip>:8080/"
/bin/busybox echo "============================================"

# Start respawning shell on serial console
(while true; do
    /bin/busybox setsid /bin/busybox sh -c 'trap "" HUP; TERM=dumb PS1="# " exec sh' </dev/ttyS1 >/dev/ttyS1 2>&1
    sleep 1
done) &

# Start shell on main console
exec /bin/busybox sh
